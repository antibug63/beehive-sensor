<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bienenstock Sensor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css"/>
</head>
<body>
    <h1>Bienenstock Sensor Daten</h1>

    <h2>Aussentemperatur</h2>
    <canvas id="outerChart" width="600" height="200"></canvas>

    <h2>Luftfeuchtigkeit</h2>
    <canvas id="humidityChart" width="600" height="200"></canvas>

    <h2>Batteriespannung</h2>
    <canvas id="batteryChart" width="600" height="200"></canvas>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script>
    const devId = 'cube-cell-1';
    const fromDate = moment().subtract(1, 'day').format('YYYY-MM-DD');
    const url = "https://ibq5ng1v73.execute-api.eu-central-1.amazonaws.com/v0/sensor/" + devId + "?from=" + fromDate;

    const timeSeries = (data, selector) => data.readings.map(reading => (
        {
            t: reading.timestamp,
            y: selector(reading)
        }
    ));

    const timeAxis = {
        type: "time",
        time:  {
            unit: 'hour', // hour, day
            parser: "YYYY-MM-DDTHH:mm:ss.fZ",
            tooltipFormat: "HH:mm:ss",
            displayFormats: {
                hour: 'D.MMM. HH:mm',
                day: 'D. MMM'
            }
        },
        scaleLabel: {
            display:     true,
            labelString: 'Time'
        }
    };

    const temperatureAxis = {
        scaleLabel: {
            display:     true,
            labelString: '°C'
        },
        ticks: {
            suggestedMin: 5,
            suggestedMax: 25
        }
    };

    const humidityAxis = {
        scaleLabel: {
            display:     true,
            labelString: '%rel'
        },
        ticks: {
            suggestedMin: 0,
            suggestedMax: 100
        }
    };

    const batteryAxis = {
        scaleLabel: {
            display:     true,
            labelString: 'Volt'
        },
        ticks: {
            suggestedMin: 4.0,
            suggestedMax: 4.1
        }
    };

    function createChart(element, label, data, axis, color, bgColor) {
        return new Chart(document.getElementById(element), {
            type: 'line',
            data: {
                datasets: [{
                    label: label,
                    cubicInterpolationMode: "monotone",
                    borderColor: color,
                    backgroundColor: bgColor,
                    data: data
                }]
            },
            options: {
                scales: {
                    xAxes: [timeAxis],
                    yAxes: [axis]
                }
            }
        });
    };

    function renderChart(data) {
        createChart('outerChart', 'Aussentemperatur [°C]', timeSeries(data, r => r.sensor.temperature.outer), temperatureAxis, "rgba(255, 0, 0, 0.9)", "rgba(255, 0, 0, 0.1)");
        createChart('humidityChart', 'Luftfeuchtigkeit [%rel]', timeSeries(data, r => r.sensor.humidity.outer), humidityAxis, "rgba(64, 128, 255, 0.9)", "rgba(64, 128, 255, 0.1)");
        createChart('batteryChart', 'Batterie [V]', timeSeries(data, r => r.sensor.battery), batteryAxis, "rgba(0, 0, 255, 0.9)", "rgba(0, 0, 255, 0.1)");
    }

    axios.get(url)
        .then(response => {
            //console.log(response);
            renderChart(response.data);
        })
        .catch(err => console.log(err));

</script>
</html>